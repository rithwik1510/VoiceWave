# VoiceWave Shared Agent Rules

This is the persistent coordination file for all agents in this repository.
All agents must follow these rules before and during implementation.

## 1) Canonical References

- Product plan: `Idea.md`
- Visual baseline: `Frontend .png`
- Agent kickoff file: `AGENT_START.md`

## 2) Locked Product Decisions

1. Frontend stack in Tauri: React + Tailwind.
2. The provided prototype image is the official v1 visual baseline.
3. v1 is strict local-only (no cloud rewrite path in v1).
4. Battery target: <= 12% drain over 30 minutes active dictation (reference laptop).
5. Official v1 supported app matrix (top 10):
   - Chrome
   - Edge
   - Safari (macOS)
   - Google Docs (browser)
   - Slack (desktop/web)
   - Notion (desktop/web)
   - VS Code
   - Cursor
   - Notepad (Windows)
   - Notes (macOS)
6. CI platform baseline: GitHub Actions.
7. ADR format baseline: Nygard ADR format.
8. Phase 0 benchmark peers: Wispr Flow, Raycast, Superwhisper, MacWhisper.
9. Temporary platform execution override (effective 2026-02-10): implement and validate on Windows only unless the user explicitly re-enables macOS work.

## 3) Phase Discipline

1. Work must follow the phase gates in `Idea.md`.
2. Do not implement future-phase scope unless explicitly reassigned.
3. Each agent must clearly tag their work with phase context in commit/notes.
4. Parallel phase work is allowed, but every agent must preserve shared contracts (locked decisions, state model, local-only policy).
5. If new files appear from another active phase, do not revert them; integrate them through docs, CI, and interface checks.
6. If `AGENT_START.md` assignment conflicts with an explicit user reassignment in-session, follow the user's latest explicit assignment and log the change in `Mistake Log`.
7. While the Windows-only execution override is active, do not spend implementation or test cycles on macOS tasks.

## 4) UI and UX Guardrails

1. Match prototype structure and information hierarchy unless a documented exception is added.
2. Keep state visibility deterministic: idle, listening, transcribing, inserted, error.
3. Never introduce UI behavior that conflicts with local-only privacy posture.

## 5) Quality and Safety Rules

1. Reliability and insertion correctness are prioritized over feature count.
2. Permission flows must have denial recovery and fallback UX.
3. Any architecture-impacting change requires a short decision entry in this file.
4. Any UI-core command/event contract rename or payload change must be reflected in RFC/ADR docs in the same work cycle.
5. When Rust core modules are present in Phase I+, CI must include Rust compile/test checks (or an explicit temporary waiver in phase notes).
6. Any web-mode demo state simulation must support cancellation and include a unit test for cancellation behavior.
7. Any substantial frontend refactor in an active phase must add or update tests for critical state transitions and primary controls.
8. If multiple prototype code trees exist, the authoritative implementation path must be documented and non-authoritative copies must be archived or explicitly excluded.
9. `voicewave-prototype/` is an approved frontend reference artifact already used in Phase I; treat it as frontend-only source material and do not open/use it for non-frontend work.
10. `voicewave-prototype/` is non-runtime and non-release scope; do not wire its cloud/API-key patterns into active v1 runtime paths unless explicitly reassigned by the user.
11. Phase I validation must include at least one desktop-feature compile path (`--features desktop` or default features), not only `--no-default-features`.
12. Phase battery/thermal evidence is signoff-valid only when capture duration is at least 30.0 minutes with explicit hardware context.
13. Development scripts and build steps must support workspace paths containing spaces on Windows.
14. Dictation cancellation must interrupt active microphone capture loops promptly, not only post-capture inference stages.
11. Rust toolchain invocation must be documented for Windows shells where PATH is stale; fallback command is `C:\Users\posan\.cargo\bin\cargo.exe`.
12. If MSVC linker setup is unavailable, GNU toolchain fallback may be used for compile diagnostics (`cargo +stable-x86_64-pc-windows-gnu ...`) with LLVM-MinGW on PATH.
13. Any toolchain-run failure must log whether the blocker is environment setup or project code, with exact file/line references when code is at fault.
14. Any new Phase II+ command surface must pass at least one desktop-feature compile path and one unit-test path before handoff notes are published.
15. Any change that touches `src-tauri/src/lib.rs` command wiring must keep `src-tauri/src/state.rs` present and compiling in the same work cycle.
16. Any new Phase III command surface must include matching frontend bridge/types wiring and at least one UI smoke test in the same work cycle.
17. Phase III cannot be marked complete unless signed manifest verification, resumable installer behavior, tamper quarantine path, required security/reliability tests, and history encryption (or documented ADR deferment) are all delivered with evidence artifacts.
17. Any Phase II hotkey completion claim must include OS-level global registration evidence (or be explicitly labeled app-scoped fallback) plus at least one validation artifact.
18. Any Phase III model-manager handoff claim must include signed-manifest fields, interrupted-download resume behavior, and a cancellation/recovery test artifact in the same cycle.
19. Any persistence layer that stores transcript/history content must either encrypt at rest when retention is enabled or include an ADR-documented deferment with risk acceptance.
20. When phase completion status changes (for example, Phase II/III done), `README.md` and phase status summaries must be updated in the same work cycle.
21. No phase may be marked complete when its core runtime dependency is still mock-only (for ASR phases, this means real whisper.cpp decode path evidence is required).
22. Windows GNU whisper.cpp builds must use bindgen-compatible `libclang` setup and verbatim static library linking (`ggml.a` / `ggml-base.a` / `ggml-cpu.a`) before Phase II/III handoff evidence is published.
23. Windows developer run scripts (`tauri:dev` / `tauri:build`) must enforce GNU toolchain fallback when MSVC linker is unavailable and must use a no-space workspace path strategy.
24. Windows GNU run scripts must prioritize a GCC-based MinGW toolchain path (WinLibs) ahead of LLVM-MinGW clang wrappers, and Vite dev configuration must pin `optimizeDeps.entries` to the authoritative app entrypoint when parallel prototype trees exist.
25. Installed model index must be reconciled against on-disk artifacts at startup; missing or size-mismatched model files must be pruned before runtime use.
26. Invalid hotkey settings must never crash startup; fall back to default hotkeys and persist a valid config.
27. Any phase-status or validation-pass claim in `README.md` / phase docs must be backed by same-cycle command output from the current branch; stale pass claims must be corrected immediately.
28. Windows Rust compile/test instructions must use a no-space workspace strategy (wrapper script or temporary junction) when the repo path contains spaces; raw space-path commands are diagnostic-only and must be labeled as such.
29. ASR quality signoff cannot rely only on fixture/scripted transcript harnesses; each active ASR phase must include at least one real microphone + whisper.cpp quality artifact.
30. Transcript text must strip or quarantine non-user special tokens (example: `[BLANK_AUDIO]`) before insertion/history/dictionary ingestion unless explicitly surfaced as diagnostics.
31. Runtime must warn when the selected microphone path is likely low-quality for ASR (for example Bluetooth hands-free profiles) and offer an in-app device-switch recovery path.
32. `docs/PHASE1_IMPLEMENTATION.md` and `docs/PHASE3_IMPLEMENTATION.md` must be reconciled in the same cycle whenever runtime decode status or validation evidence changes.
33. Home-screen mic start must not hard-fail on first-run model mismatch; runtime must auto-select an installed model or bootstrap `tiny.en` with explicit status feedback.
34. Home-screen mic control semantics are press-and-hold by default: release must transition to finish/transcribe flow, and short/empty captures must not raise hard error state.
35. Insertion fallback outcomes (`historyFallback` / clipboard-only preserve) must be surfaced as non-fatal state feedback, not promoted to global error state.
36. Transcript streaming must emit cumulative partial text across capture segments and publish exactly one utterance-level final event to avoid last-segment overwrite behavior.
37. When phase status is rebaselined, `docs/PHASE_RECOVERY_PLAN.md` and any phase implementation doc with contradictory status claims must be updated in the same cycle.
38. Readiness/validation automation must not hardcode date-stamped artifact filenames when rolling artifacts are expected; scripts must resolve the latest matching artifact pattern.
39. Readiness pass/fail parsers must anchor to structured checklist rows (not freeform prose) to avoid false positives from instructional text.
40. If a hard quality gate is temporarily deferred (example: sustained battery run), the deferment must include a `Status: Complete` marker file, explicit target phase for closure, and matching readiness-script logic in the same cycle.
41. Manual acceptance templates must keep pass/fail markers as raw checklist tokens (`[x] pass / [ ] fail`) and must not wrap them in code formatting that breaks gate parsers.
42. When `src-tauri/tauri.conf.json` sets `"bundle.active": true`, `bundle.icon` must include a valid Windows `.ico` path and at least one `tauri:build` verification run must be recorded in the same cycle.
43. Push-to-talk microphone capture must not auto-transition to transcribing from silence timeout after speech is detected; transcription starts only on explicit release/stop (or max utterance cap).
44. Global hotkey runtime polling must never await long-running dictation flows inline; hotkey actions must be dispatched asynchronously so press/release edges continue to process during active capture.
45. Frontend must suppress browser-default key handling for configured dictation hotkey combos (example: `Ctrl+Alt+Space`) in non-editable contexts to prevent in-app scroll/focus jumps during push-to-talk.
46. Any asynchronously dispatched push-to-talk `pressed` action must re-check current key-down state before starting dictation so stale `pressed` tasks cannot start a new session after release.

## 6) Auto-Update Mistake Rule (Mandatory)

If any agent finds a mistake, inconsistency, regression risk, or missing rule:

1. Update this `AGENTS.md` immediately in the same work cycle.
2. Add a new entry in `Mistake Log` using the template below.
3. Add/adjust a prevention rule under the relevant section.

Mistake log template:

- Date:
- Agent:
- Phase:
- Issue:
- Impact:
- Fix applied:
- Prevention rule added:

## 7) Mistake Log

- 2026-02-10 | Agent: Codex | Phase: Setup | Issue: No shared persistent agent rule file existed. | Impact: Multi-agent drift risk. | Fix applied: Created `AGENTS.md` and `AGENT_START.md`. | Prevention rule added: Mandatory startup checklist + auto-update mistake rule.
- 2026-02-10 | Agent: Codex | Phase: 0 | Issue: Parallel Phase 1 files appeared without explicit integration protocol. | Impact: Risk of CI/docs drift across agents. | Fix applied: Added parallel integration rules and CI alignment for shared workspace. | Prevention rule added: Phase discipline now includes explicit parallel-phase integration behavior.
- 2026-02-10 | Agent: Codex | Phase: I | Issue: `AGENT_START.md` still listed this agent as Phase 0-only while user explicitly reassigned this session to Phase I. | Impact: Assignment ambiguity and potential blocked execution. | Fix applied: Proceeded with explicit user reassignment and recorded override rule in Phase Discipline. | Prevention rule added: User reassignment overrides kickoff assignment when conflicts exist.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Phase I Rust runtime modules exist, but CI currently validates only frontend tests/build and skips Rust compile/test jobs. | Impact: Core audio/inference regressions can pass CI undetected. | Fix applied: Logged integration gap during review and added explicit CI prevention rule. | Prevention rule added: Quality and Safety rule 5.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Implemented Tauri command/event names diverged from Phase 0 RFC interface contract without companion ADR/RFC update. | Impact: Cross-agent contract drift risk between docs and runtime integration. | Fix applied: Logged contract drift during review and added documentation-sync prevention rule. | Prevention rule added: Quality and Safety rule 4.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Web fallback demo flow in `useVoiceWave` schedules uncancelled timers, allowing state to transition after user presses Cancel. | Impact: Incorrect state feedback and flaky demo behavior outside Tauri runtime. | Fix applied: Logged behavior risk during review and added cancellation-test prevention rule. | Prevention rule added: Quality and Safety rule 6.
- 2026-02-10 | Agent: Codex | Phase: I Closeout | Issue: Phase I runtime command/event contract drifted from RFC and remained unsynced while implementation evolved. | Impact: Integration ambiguity across UI/core and parallel agents. | Fix applied: Standardized on `start_dictation(mode)` + `cancel_dictation`, added state payload message support, and updated RFC + implementation notes in same cycle. | Prevention rule added: Quality and Safety rule 4.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Large Phase I UI refactor landed with only `stateLabel` unit tests and no component/hook interaction coverage for record toggling and state display. | Impact: Higher risk of undetected UI behavior regressions. | Fix applied: Logged coverage gap and added frontend-refactor testing rule. | Prevention rule added: Quality and Safety rule 7.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Parallel prototype code trees now exist (`src/prototype` and `voicewave-prototype`) without explicit authority documentation. | Impact: Drift/confusion risk for future agents and reviewers. | Fix applied: Logged source-of-truth risk and added prototype-authority rule. | Prevention rule added: Quality and Safety rule 8.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: `voicewave-prototype` contains cloud AI dependency wiring (`@google/genai`, `GEMINI_API_KEY`) while v1 policy is strict local-only. | Impact: Initially flagged as policy drift risk. | Fix applied: Superseded by user clarification that this directory is an intentional Gemini-exported frontend prototype and non-runtime reference. | Prevention rule added: Quality and Safety rules 9 and 10.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Prior review treated `voicewave-prototype` as a direct project risk without user context that it is an intentional Gemini-exported frontend prototype. | Impact: Could create unnecessary cleanup or review noise. | Fix applied: Reclassified `voicewave-prototype` as approved frontend-only reference material used by Phase I; constrained usage for non-frontend tasks. | Prevention rule added: Quality and Safety rules 9 and 10.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Rust validation paths (`CI` + local script) rely on `--no-default-features`, which skips desktop-gated runtime code in `src-tauri/src/state.rs` and command wiring in `src-tauri/src/lib.rs`. | Impact: Desktop runtime regressions can slip through while tests stay green. | Fix applied: Logged coverage gap and added desktop-feature compile requirement. | Prevention rule added: Quality and Safety rule 11.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Current battery report (`docs/phase1/phase1-battery-thermal-windows.json`) shows only ~1.01 minutes duration, below the 30-minute gate target. | Impact: Phase I battery gate evidence is incomplete for handoff confidence. | Fix applied: Logged evidence-quality requirement for phase signoff artifacts. | Prevention rule added: Quality and Safety rule 12.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Desktop-feature Rust compile failed in workspace path with spaces during review (`voice vibe`), with `windres` resource build path parsing failure. | Impact: Local developer workflow can fail despite no-default-features checks passing. | Fix applied: Logged Windows path-space compatibility requirement for build scripts. | Prevention rule added: Quality and Safety rule 13.
- 2026-02-10 | Agent: Codex | Phase: I Review | Issue: Microphone-mode capture runs in a blocking capture loop and cancellation currently takes effect only after capture returns, not during capture. | Impact: Stop action may appear immediate in UI while microphone capture thread can continue until timeout/silence conditions. | Fix applied: Logged cooperative-cancellation requirement for capture loops. | Prevention rule added: Quality and Safety rule 14.
- 2026-02-10 | Agent: Codex | Phase: I Tooling | Issue: `cargo` was unavailable in shell PATH and MSVC linker (`link.exe`) was missing for default host builds, blocking Rust test execution. | Impact: Rust validation initially failed as environment issue rather than code signal. | Fix applied: Verified rustup toolchain install, installed LLVM-MinGW fallback, and ran `cargo +stable-x86_64-pc-windows-gnu test` to reach code-level errors. | Prevention rule added: Quality and Safety rules 11, 12, and 13.
- 2026-02-10 | Agent: Codex | Phase: I Scope | Issue: Phase I docs still implied macOS validation work in the current execution cycle after user confirmed only Windows hardware is available. | Impact: Risk of wasted implementation/testing time on unavailable platform. | Fix applied: Added Windows-only execution override in planning/runtime docs and agent rules. | Prevention rule added: Locked Product Decision 9 and Phase Discipline rule 7.
- 2026-02-10 | Agent: Codex | Phase: II | Issue: Initial Phase II runtime patch introduced compile blockers (`src-tauri/src/state.rs` async error mapping and `src-tauri/src/insertion/mod.rs` borrow conflict) before verification. | Impact: Desktop-feature Rust compile path failed until corrected. | Fix applied: Corrected error mapping to `ControllerError::Tauri`, resolved borrow conflict with staged transaction id, and re-ran GNU desktop compile + lib tests. | Prevention rule added: Quality and Safety rule 14.
- 2026-02-10 | Agent: Codex | Phase: II Stabilization | Issue: Parallel edits left `src-tauri/src/lib.rs` still referencing `state` while `src-tauri/src/state.rs` was missing, and Rust core had unresolved compile blockers (`sha2` dependency + dictionary mutable borrow). | Impact: Phase II runtime was non-compilable and unsafe for handoff. | Fix applied: Rebuilt `state.rs` controller/event wiring, restored compile integrity, added missing dependency, fixed borrow bug, and validated both no-default tests and desktop-feature compile path. | Prevention rule added: Quality and Safety rule 15.
- 2026-02-10 | Agent: Codex | Phase: III | Issue: Phase III backend command surface existed, but frontend tabs/bridge/types were not fully wired, leaving sidebar sections functionally static. | Impact: Users could see UI structure but could not operate model/history/dictionary controls end-to-end. | Fix applied: Wired Phase III commands into `src/lib/tauri.ts`, `src/types/voicewave.ts`, `src/hooks/useVoiceWave.ts`, and `src/App.tsx`, and added tab smoke tests. | Prevention rule added: Quality and Safety rule 16.
- 2026-02-10 | Agent: Codex | Phase: III Review | Issue: Phase III progress was reported too optimistically after UI/command wiring while critical security/reliability scope (signed manifest verification, resumable installer pipeline, tamper quarantine recovery, encryption-at-rest, and hardware-tier recommendation evidence) was still incomplete. | Impact: Handoff confidence was overstated and completion status was ambiguous. | Fix applied: Reclassified Phase III as incomplete, documented strict completion gate criteria in agent rules, and queued missing scope for implementation in current cycle. | Prevention rule added: Quality and Safety rule 17.
- 2026-02-10 | Agent: Codex | Phase: II+III Review | Issue: Runtime hotkey flow remains app-window scoped (`window` key listeners) while Phase II goals call for global hotkeys; core path does not yet provide verified OS-level registration behavior. | Impact: Dictation hotkeys may fail when VoiceWave is unfocused, reducing insertion reliability against gate intent. | Fix applied: Logged scope gap during integration review and added explicit global-hotkey evidence rule. | Prevention rule added: Quality and Safety rule 17.
- 2026-02-10 | Agent: Codex | Phase: III Review | Issue: Model manager currently installs deterministic local artifacts synchronously without signed manifest metadata, interrupted-download resume, or meaningful cancellation/recovery path. | Impact: Phase III model pipeline gates (signed manifest + resumable installer reliability) are only partially met. | Fix applied: Logged model-pipeline gate gap during integration review and added mandatory handoff evidence rule. | Prevention rule added: Quality and Safety rule 18.
- 2026-02-10 | Agent: Codex | Phase: III Review | Issue: Session history/settings persistence remains plain JSON files without encryption-at-rest for retained transcript content. | Impact: Diverges from architecture/privacy requirement for encrypted history when enabled. | Fix applied: Logged persistence-security gap during integration review and added encryption-or-ADR requirement. | Prevention rule added: Quality and Safety rule 19.
- 2026-02-10 | Agent: Codex | Phase: II+III Review | Issue: `README.md` still describes active implementation as Phase 1 stream and omits Phase III validation status/command in current repo state. | Impact: Onboarding and release-readiness visibility can drift from actual implementation state. | Fix applied: Logged documentation drift during integration review and added same-cycle status-update rule. | Prevention rule added: Quality and Safety rule 20.
- 2026-02-10 | Agent: Codex | Phase: I-III Rebaseline | Issue: Phase progress communication drifted from core plan by advancing phase claims while inference runtime still relied on mock decode output. | Impact: Misaligned expectations about whether whisper.cpp-backed dictation was actually complete. | Fix applied: Rebased master docs (`README.md`, `Idea.md`, phase docs) to whisper.cpp-first truth and added explicit recovery plan. | Prevention rule added: Quality and Safety rule 21.
- 2026-02-10 | Agent: Codex | Phase: I-III Toolchain | Issue: Windows GNU whisper.cpp build used generated bindings with enum-sign mismatch and CMake produced non-prefixed `ggml*.a` archives that were not linked by default, blocking desktop compile validation. | Impact: Rust desktop compile path failed despite inference/runtime implementation being present. | Fix applied: Installed LLVM `libclang`, switched to generated bindings via `.cargo/config.toml`, patched `vendor/whisper-rs` enum discriminant casts, and patched `vendor/whisper-rs-sys/build.rs` to emit verbatim static link directives and robust link-path discovery. | Prevention rule added: Quality and Safety rule 22.
- 2026-02-10 | Agent: Codex | Phase: Dev Experience | Issue: `tauri dev` defaulted to MSVC host and failed on machines without `link.exe`, even though GNU toolchain fallback was already validated for this workspace. | Impact: Local run/build was blocked for contributors lacking Visual Studio Build Tools. | Fix applied: Added Windows Tauri wrapper scripts that enforce GNU toolchain, inject MinGW paths, and run from a no-space junction path; rewired `package.json` `tauri:dev` and `tauri:build` scripts. | Prevention rule added: Quality and Safety rule 23.
- 2026-02-10 | Agent: Codex | Phase: Dev Experience Stabilization | Issue: Tauri dev wrappers still failed because LLVM-MinGW clang wrappers were taking precedence over WinLibs GCC (`-lgcc`/`-lgcc_eh` unresolved), and Vite dep scan attempted to index both root and `voicewave-prototype` HTML entries during beforeDev startup. | Impact: Local app startup remained unstable with repeated linker and dep-scan failures. | Fix applied: Forced WinLibs MinGW precedence in Tauri wrapper scripts and constrained Vite dependency entry scanning to `index.html` while ignoring `voicewave-prototype` watch paths. | Prevention rule added: Quality and Safety rule 24.
- 2026-02-10 | Agent: Codex | Phase: II/III Model Manager | Issue: Installed model index could list missing model files, causing dictation errors and phantom installs. | Impact: Dictation failed with missing model path while UI showed installed state. | Fix applied: Reconciled installed index against disk artifacts at startup and removed missing/size-mismatched entries; added runtime guard when resolving active model. | Prevention rule added: Quality and Safety rule 25.
- 2026-02-10 | Agent: Codex | Phase: II/III Hotkeys | Issue: Invalid hotkey token (example: `WIN`) in settings caused startup panic in `HotkeyManager::new`. | Impact: Tauri runtime crashed at launch with exit code 101. | Fix applied: Added `WIN`/`WINDOWS` alias handling and fallback to default hotkeys on invalid config during startup. | Prevention rule added: Quality and Safety rule 26.
- 2026-02-11 | Agent: Codex | Phase: Cross-Phase Review | Issue: Current branch validation state regressed from documented claims (`npm run test -- --run` failing `src/App.test.tsx`; `npm run build` failing TS6133 in `src/hooks/useVoiceWave.ts`). | Impact: README/Phase III status overstates readiness and can mislead triage/handoff. | Fix applied: Logged documentation-evidence drift and reset expectations for next stabilization cycle. | Prevention rule added: Quality and Safety rule 27.
- 2026-02-11 | Agent: Codex | Phase: Dev Experience Review | Issue: Direct desktop compile command in workspace path with spaces still fails (`windres` path parsing) while no-space wrapper strategy is required for reliable verification. | Impact: Contributors may conclude runtime is broken when the blocker is path/toolchain invocation shape. | Fix applied: Logged instruction-safety gap and enforced explicit no-space command policy. | Prevention rule added: Quality and Safety rule 28.
- 2026-02-11 | Agent: Codex | Phase: I/II ASR Review | Issue: Phase benchmark/stability artifacts still come from fixture/scripted transcript paths rather than real microphone whisper.cpp quality measurements. | Impact: Product-quality confidence can be overstated despite poor real dictation output. | Fix applied: Logged quality-evidence gap for immediate stabilization planning. | Prevention rule added: Quality and Safety rule 29.
- 2026-02-11 | Agent: Codex | Phase: Runtime QA | Issue: Live transcript artifacts showed special token leakage (`[BLANK_AUDIO]`) entering dictionary queue/history content. | Impact: User-facing transcript quality appears broken even when decode executes. | Fix applied: Logged transcript sanitization requirement before insertion/history pipelines. | Prevention rule added: Quality and Safety rule 30.
- 2026-02-11 | Agent: Codex | Phase: Runtime QA | Issue: Active settings used a Bluetooth headset microphone profile with elevated VAD threshold during poor-transcription reports, without explicit runtime quality warning. | Impact: Users can remain on low-quality capture paths and perceive model/runtime failure. | Fix applied: Logged required microphone-quality warning and recovery UX gap for next patch cycle. | Prevention rule added: Quality and Safety rule 31.
- 2026-02-11 | Agent: Codex | Phase: Documentation Rescue | Issue: `docs/PHASE1_IMPLEMENTATION.md` still claimed mock-only decode while Phase III/runtime docs reported whisper.cpp desktop integration. | Impact: Contradictory phase status could mislead rescue decisions and quality triage. | Fix applied: Rewrote Phase I/III implementation notes and README evidence to reflect current validated runtime truth. | Prevention rule added: Quality and Safety rule 32.
- 2026-02-11 | Agent: Codex | Phase: Runtime Rescue | Issue: Home mic button returned immediate error when active model was not locally installed, forcing users into manual model triage before first dictation. | Impact: Primary dictation action felt broken despite recoverable runtime state. | Fix applied: Added automatic model readiness recovery (switch installed fallback or bootstrap `tiny.en`) and preflight microphone permission check in `useVoiceWave` run path. | Prevention rule added: Quality and Safety rule 33.
- 2026-02-11 | Agent: Codex | Phase: Runtime UX Rescue | Issue: Mic interaction behavior drifted away from push-to-talk hold semantics, and short-release/no-speech paths surfaced a hard error state. | Impact: Users saw immediate red errors while attempting normal hold/release dictation flow. | Fix applied: Restored press-and-hold mic button behavior and handled no-speech release paths as non-error idle transitions in runtime controller. | Prevention rule added: Quality and Safety rule 34.
- 2026-02-11 | Agent: Codex | Phase: Runtime UX Rescue | Issue: Insertion fallback outcomes were mapped to global error HUD state even when transcript was preserved, creating false-negative "broken" feedback. | Impact: Users saw red error state despite recoverable insertion behavior. | Fix applied: Reclassified non-success insertion results to non-fatal inserted feedback path and removed misleading auto-install status from error UI channel. | Prevention rule added: Quality and Safety rule 35.
- 2026-02-11 | Agent: Codex | Phase: Runtime Transcript UX | Issue: Transcript UI consumed per-segment final events, causing final text to collapse to the last segment/word despite multi-segment speech. | Impact: Users saw word-by-word replacement and perceived incomplete sentence transcription. | Fix applied: Emitted cumulative partial transcript across segments and a single utterance-level final transcript event after segment aggregation. | Prevention rule added: Quality and Safety rule 36.
- 2026-02-11 | Agent: Codex | Phase: Phase IV/V Prep Cleanup | Issue: Phase status docs diverged (`docs/PHASE_RECOVERY_PLAN.md` and `docs/PHASE2_IMPLEMENTATION.md` still described earlier blocked states despite validated rescue baseline). | Impact: Could mis-sequence Phase IV/V planning and create false blockers/assumptions. | Fix applied: Rebaselined recovery/phase docs, added Phase IV/V readiness docs, and introduced prep/gate scripts with explicit blocker reporting. | Prevention rule added: Quality and Safety rule 37.
- 2026-02-11 | Agent: Codex | Phase: Phase IV Readiness Automation | Issue: `scripts/phase4/run-phase4-readiness.ps1` required a date-locked manual acceptance filename (`windows-manual-acceptance-2026-02-11.md`), creating false failures after the artifact date rolls. | Impact: Phase IV/Phase V prep status can fail despite valid new acceptance artifacts being present. | Fix applied: Switched script to resolve the latest `windows-manual-acceptance-*.md` artifact dynamically and synced readiness doc wording. | Prevention rule added: Quality and Safety rule 38.
- 2026-02-11 | Agent: Codex | Phase: Phase IV Readiness Automation | Issue: Manual acceptance pass detection used a broad regex that could match instructional prose, creating false-positive gate results. | Impact: Phase IV readiness could show a pass for manual acceptance without any checklist rows actually marked as passed. | Fix applied: Anchored pass detection to checklist row format and adjusted instructions to avoid marker-like prose. | Prevention rule added: Quality and Safety rule 39.
- 2026-02-11 | Agent: Codex | Phase: Phase IV Signing Hardening | Issue: Invalid-manifest-signature install path could leave orphan `.partial` model artifacts when checkpoint metadata was absent. | Impact: Tampered/invalid model attempts could leave stale files and inconsistent install-state hygiene. | Fix applied: Updated model-manager invalid-signature handling to quarantine/remove orphan partial artifacts even without checkpoint metadata; added evidence log with passing tamper/signature tests. | Prevention rule added: Quality and Safety rule 40.
- 2026-02-11 | Agent: Codex | Phase: Phase IV Readiness Automation | Issue: Manual acceptance rows used markdown code formatting around pass/fail markers, causing parser false-negatives despite marked pass rows. | Impact: Phase IV gate could fail even when checklist intent was satisfied. | Fix applied: Normalized checklist rows to raw `[x] pass / [ ] fail` tokens in the acceptance artifact and re-ran gate. | Prevention rule added: Quality and Safety rule 41.
- 2026-02-11 | Agent: Codex | Phase: V Build Verification | Issue: `npm run tauri:build` failed during bundle step with `Couldn't find a .ico icon` because `src-tauri/tauri.conf.json` had `"bundle.icon": []` while bundling was active. | Impact: Windows release packaging was blocked even though compile/test/reliability gates were green. | Fix applied: Updated `src-tauri/tauri.conf.json` to include `icons/icon.ico` in `bundle.icon` and re-ran `tauri:build`. | Prevention rule added: Quality and Safety rule 42.
- 2026-02-11 | Agent: Codex | Phase: V Push-to-Talk Reliability | Issue: Microphone capture timeout path could transition to transcript before push-to-talk release because timeout handling auto-finished after speech/silence windows. | Impact: Users saw transcribing begin while still holding the push-to-talk keys. | Fix applied: Updated `src-tauri/src/audio/mod.rs` timeout logic to keep listening after speech until explicit stop/release (or max utterance cap), and added a regression test for release-tail capture behavior. | Prevention rule added: Quality and Safety rule 43.
- 2026-02-11 | Agent: Codex | Phase: V Push-to-Talk Hotkey Runtime | Issue: Windows hotkey monitor awaited `trigger_hotkey_action` inline; push-to-talk press blocked the polling loop during active capture, so release edges were delayed/missed. Browser key defaults also caused in-app scroll jumps during shortcut use. | Impact: Dictation could stay listening after release and UI scrolled unexpectedly to lower sections while dictating. | Fix applied: Dispatched hotkey actions via async spawned tasks in `src-tauri/src/state.rs` and added frontend combo-key suppression in `src/hooks/useVoiceWave.ts`. | Prevention rule added: Quality and Safety rules 44 and 45.
- 2026-02-11 | Agent: Codex | Phase: V Push-to-Talk Race Fix | Issue: After async hotkey dispatch, stale `pressed` tasks could execute after key release and start dictation without a matching stop edge. | Impact: Single-word dictation could get stuck in listening until another manual stop action. | Fix applied: Added key-state revalidation inside `trigger_hotkey_action` pressed branch before `start_dictation` in `src-tauri/src/state.rs`. | Prevention rule added: Quality and Safety rule 46.

## 8) Decision Log

- 2026-02-10 | Phase: I | Decision: Implemented a mock local inference adapter first (cancellable + partial streaming contract) before wiring whisper.cpp runtime. | Rationale: De-risks event/state architecture and UI integration early while preserving Phase I boundaries. | Revisit Trigger: Replace with whisper.cpp-backed decoder inside Phase I before exit criteria signoff.
- 2026-02-10 | Phase: I | Decision: Adopted dual-source dictation entry (`microphone` default, `fixture` deterministic fallback) under a single `start_dictation(mode)` contract. | Rationale: Enables real mic path for Phase I goals while keeping deterministic testability for CI/stability loops. | Revisit Trigger: Remove or hide fixture mode from production UX once full on-device inference confidence is established.
- 2026-02-10 | Phase: I | Decision: Added Phase I validation harness (`phase1_harness`) and CI Rust test gate on Windows. | Rationale: Exit criteria require latency/stability evidence and Rust regressions must fail CI. | Revisit Trigger: Replace harness-derived fixture metrics with device-lab microphone + whisper.cpp benchmark reports.
- 2026-02-10 | Phase: I | Decision: Apply temporary Windows-only implementation and validation scope due available hardware constraints. | Rationale: Keeps progress focused and prevents blocked macOS-only work while still preserving v1 cross-platform target in product plan. | Revisit Trigger: Resume macOS Phase I parity when macOS hardware is available.
- 2026-02-10 | Phase: II | Decision: Added explicit hotkey/insertion/permission command-event surfaces while preserving existing Phase I `start_dictation(mode)` + `cancel_dictation` contracts. | Rationale: Enables parallel Phase III work with stable integration interfaces and deterministic state/event behavior. | Revisit Trigger: Replace in-app keyboard hotkey bridge with OS-global registration when dedicated global shortcut plugin path is approved.
- 2026-02-10 | Phase: II | Decision: Insertion engine uses deterministic fallback ordering (`direct -> clipboardPaste -> clipboardOnly -> historyFallback`) with undo token and recent insertion ring buffer. | Rationale: Prioritizes reliability and data safety over platform-specific insertion optimization in this cycle. | Revisit Trigger: Upgrade direct insertion backend per supported-app matrix once platform-specific adapters are ready.
- 2026-02-10 | Phase: III | Decision: Kept all Phase II command/event contracts stable and added Phase III capabilities as additive command surfaces only. | Rationale: Preserves integration safety for parallel agents while enabling model manager, benchmark, retention, and dictionary queue workflows. | Revisit Trigger: Consider command consolidation only after Phase III freeze and shared RFC update.
- 2026-02-10 | Phase: III | Decision: Implemented left-nav Phase III sections (`models`, `sessions`, `dictionary`, `settings`) using the existing prototype shell with runtime-backed actions and web fallback simulation. | Rationale: Delivers functional parity with current app structure without visual churn or policy drift from local-only posture. | Revisit Trigger: Revisit panel composition when Phase IV adds diagnostics/release controls.
- 2026-02-10 | Phase: I-III Runtime | Decision: Vendor-patched `whisper-rs` + `whisper-rs-sys` for Windows GNU (`libclang` bindings + verbatim `ggml*.a` linking) to keep whisper.cpp runtime compile-valid in this workspace/toolchain. | Rationale: Upstream defaults did not reliably link GNU static archives in this environment, blocking mandatory desktop-feature validation. | Revisit Trigger: Remove local vendor patches when upstream crates provide a stable Windows GNU path without local overrides.
- 2026-02-11 | Phase: Runtime QA | Decision: Added an in-app audio chunk quality diagnostic surface (`run_audio_quality_diagnostic` command + `voicewave://audio-quality` event + Home panel report) to evaluate real captured mic chunks before decode quality tuning. | Rationale: Transcript symptoms alone are insufficient to isolate capture-vs-model failures; chunk-level metrics (RMS/clipping/low-energy/SNR proxy) create actionable root-cause visibility. | Revisit Trigger: Replace proxy heuristics with calibrated device-lab thresholds and persisted diagnostics artifacts during Phase IV/V hardening.
- 2026-02-11 | Phase: IV | Decision: Defer the 30-minute sustained battery gate from active implementation flow to Phase VI pre-GA hardening with an explicit marker file (`docs/phase4/evidence/battery-deferment.md`). | Rationale: Product owner prioritized shipping core dictation reliability before long-run battery capture; deferment keeps gate explicit and auditable without blocking stabilization work. | Revisit Trigger: Before GA release candidate signoff, run `npm run phase1:battery` and update artifact to `duration_minutes >= 30.0`.
- 2026-02-11 | Phase: V | Decision: Added additive diagnostics command surface (`get_diagnostics_status`, `set_diagnostics_opt_in`, `export_diagnostics_bundle`) and additive latency payload fields (`watchdogRecovered`, `segmentsCaptured`, `releaseStopDetectedAtUtcMs`) without renaming existing contracts. | Rationale: Phase V reliability operations require explicit opt-in diagnostics export and watchdog visibility while preserving interface stability for current frontend/runtime flows. | Revisit Trigger: Revisit payload/command consolidation only after Phase V exit gate and shared RFC update.
- 2026-02-11 | Phase: A | Decision: Added a persistent CPU inference runtime pool with model prewarm + runtime auto decode-policy (`balanced`/`fast`) while keeping user-facing settings simple and contract-compatible. | Rationale: `small.en` latency was dominated by per-utterance context initialization and manual mode selection created UX confusion; runtime-managed pooling/policy improves warm-path speed without exposing extra knobs. | Revisit Trigger: Reassess policy thresholds and pool sizing after collecting real Phase A artifact series with cache-hit and failure-rate telemetry.
